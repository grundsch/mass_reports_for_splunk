# mass_reports_for_splunk
An (ugly) script to generate a large number of sheduled PDF views in Splunk based on a template

* auto-gen TOC:
{:toc}

## Introduction

**Need**: provide a dashboard to a large group of sysadmin, showing their systems only.
 
Difficulties:
-	Cannot provide 100's of accounts on the Splunk SH (operation processes not designed to do it)
-	Permissions are tricky: limitation role->index, but what about more precise search terms? (without the possibility to bypass) -> probably doable, but needs a SH lock-down and proper role modelling
-	PDF generation as alternative
 - No templates system
 - Various workaround needed (see later)
 - Limited in formating
 - No monitoring of reporting errors (or difficult…)
 
PDF Generator:
-	Limited formating control
-	page layout, font size, graph size, graph format (size of label area vs graph area, …)
-	No bookmark/hyperlink within report

Template system:
-	Developed own script

Workarounds:
-	Scheduled PDF works only if using saved searches, not inline… http://answers.splunk.com/answers/74295/empty-scheduled-pdf-reports.html#answer-98352
-	Scheduledview report format is not used, it takes only the global configuration?!
-	Refreshing (via rest endpoint) the scheduledview does not refresh/reinitialise the schedule. I have to set explicitely again via REST the schedule. 
-	Larger charts (takes more width on the page, A3 landscape). Size is hard coded (600px)
-	Top alignement in table cells (default is bottom).
-	Line feed in Multivalue cell (nicer format in the PDF): 
  `eval Description=mvappend(Description," ",mvappend("","Advisories: ",Adv))`
- Single Value "missuse" to show conditionally a header with multiple values (text): use delim to insert `"&lt;br/&gt;"` that will be honored (fortunately!) by the PDF generator (but not by the view…)
External reporting engine?
-	Any recommendation for external reporting engine? Jasper reports?
 
## Abstract
A dashboard in Splunk can be scheduled to be delivered as PDF per email to a list of email addresses.
This works well, but only for static dashboards (simple XML dashboards without Form elements), i.e. it is not possible to give parameters to the scheduler to change the queries or the destination emails.
The solution described here consists in a script that can be run on the splunk server (search head) that will:
-	Based on a csv list of parameters and templates
-	create saved searches for every pannel for every dashboard to be generated
-	create a dashboard for every parameter set
-	schedule the dashboard for delivery following date/hour and email parameters
-	force a refresh of splunk to consider the new dashboards and schedule without restarting splunk

**Work in progress:**
This script is a work in progress. It is currently heavily tailored to my vulnerability score dashboard usecase, and doesn't perform a lot of error checking (it's my first Python script ever). Given wrong parameters, it will mostly stop without complaining much...
Help, comments, bugfixes, improvements are welcome!
Note:
Because of a bug in Splunk Scheduler, the dashboards' panels must be based on savedsearches, and not inline. If the panels use inline searches, the scheduled PDF are empty (but work fine when created manually). The script must therefore create first all saved searches, then the dashboard that references these searches.

## Structure
The script uses, edits and creates various files. They are all present in your app directory (/opt/splunk/etc/apps/your_app/ )
```
----bin
|       dashboardGenerator.py 	<--- the script
|       
----lookups
|       dashboard_list.csv	<--- the list of dashboard to generate (parameters)
|       
----local
    |   searchbnf.conf	<--- help file to display when the command is typed in the search window
    |   dashboard_generator.conf	<--- configuration file for the script
    |   template.conf	<--- template for the saved searches and scheduling
    |   commands.conf	<--- definition of the command to call the script
    |   savedsearches.conf	<--- the saved searches files from splunk, will be edited by	the script
    |   savedsearches.bak	<--- a backup (will be overwritten at each invocation of the script)
    |   
    +---data
        +---ui
            +---views
                    dashboard_platform1-perimeter.xml	<--- one report generated by the script
                    dashboard_PLATFORM2-other-internal.xml	<--- another one
                    dashboard_template.xml	<--- dashboard template
```
## Configuration files
### Script configuration
The script uses a configuration file for most of its parameters:
#### dashboard_generator.conf 
```
[dashboard_generator]
report_list_csv = ./lookups/dashboard_list.csv
file_to_edit = ./local/savedsearches.conf
backup = ./local/savedsearches.bak
prefix = dashboard_
dashboard_path = ./local/data/ui/views/
dashboard_template = dashboard_template.xml
savedsearches_template = ./local/template.conf
```
parameter|	description
------------- | -------------
report_list_csv	|the csv list containing all parameters necessary to generate the dashboard based on the templates
file_to_edit	| must point to savedsearches.conf, it will edit this file to add the saved searches necessary to populate the dashboards
backup	| backup name of the file to edit
prefix	|everything (saved searches as well as dashboard names) will have this prefix. It is also used to DELETE existing saved searches and dashboards (anything starting with this prefix will be deleted first), so be sure to not have collisions with dashboards not managed by this script.
dashboard_path	|should not be changed, the path to the views
dashboard_template	|name of the template used to generate the dashboard files, must be in the same directory as dashboard_path
savedsearches_template	|the name of the savedsearches template file that will be used to generate the saved searches

Note:
All paths are relative to the app directory.

### Report list
This report_list_csv contains all parameters necessary to create and schedule the dashboards.
It is placed in the lookup directory, so that it can be easily edited/managed by the splunk built-in lookup functions, or via the Lookup-editor app.
#### dashboard_list.csv 
```
shortname,search_term1,search_term2,email,cron
team1,searchvalue1,searchvalue2,"email1@somecompany.com,email2@somecompany.com",0 13 * * 2
team2,searchvalue3,NOT searchvalue4,email@somecompany.com,0 7 * * 3
```
parameter|	description
------------- | -------------
shortname	|REQUIRED - will be used everywhere (in saved searches names, dashboard file names, ...). Must be unique! Must not contain "_"!
search_term1, search_term2	|name of variables used to filter the scope (here based on a lookup definition, but can be anything)
email	|REQUIRED - comma separated list of email addresses to receive the reports, if more than one must be enclosed into ""
cron	|REQUIRED - cron schedule for the PDF generation

Note:
again, "shortname" must be unique (it will be used to generate file name, and will fail if two identical ones are present), and must not contain an underscore "_".

Note:
You can add more parameters to be used in the saved searches or dashboard templates. Only the "REQUIRED" fields are used by the script, all other parameters are substituted automagically in the templates.

### saved searches template
The saved searches template contains the searches needed to populate the dashboard panels.
For every shortname (or line) in the report list, all these search templates will be created. I.e. if you have 3 panels and 10 lines, you will end up with 30 saved searches.
#### template.conf 
```
[dashboard_search1_%(shortname)s]
alert.track = 0
description = search number one
dispatch.earliest_time = -14d
dispatch.latest_time = now
display.general.type = statistics
display.statistics.overlay = heatmap
search = index=abc sourcetype=def (BASE SEARCH TERMS) eventtype=%(search_term1)s %(search_term2)s | stats count by host

[dashboard_trend_%(shortname)s]
alert.suppress = 0
alert.track = 0
description = trend
dispatch.earliest_time = -4w@w+1d
dispatch.latest_time = now
search = index=abc sourcetype=def (OTHER SEARCH TERMS)  %(search_term2)s | timechart span=1d count dc(host) as unique_hosts"

[_ScheduledView__dashboard_%(shortname)s]
action.email = 1
action.email.maxtime = 60m
action.email.message.view = A PDF was generated for $name$
action.email.paperorientation = landscape
action.email.papersize = a3
action.email.pdfview = dashboard_%(shortname)s
action.email.sendpdf = 1
action.email.subject.view = Dashboard: '$name$'
action.email.to = %(email)s
action.email.cc = 
action.email.ttl = 10
action.email.useNSSubject = 1
cron_schedule = %(cron)s
description = scheduled search for view name=dashboard_%(shortname)s
dispatch.earliest_time = 1
dispatch.latest_time = 2
enableSched = 1
is_visible = 0
search = | noop
```

#### Parameters substitution
You can use within the template python dictionary string replacement syntax, i.e. %(shortname)s will replace its occurrence in the template with the value of the "shortname" parameter from the report_list.csv file.

**Note:**
Every saved search must start with the defined "prefix", in order to be found again later: it will be used to be detected and then deleted.

Moreover, it must end with "_shortname" !!! the underscore is mandatory !!! (it is used to extract the shortname, in order to construct the name of the dashboard xml file to be deleted.)

If you need to use a literal "%" in your search queries, you need to escape them, like in 
`|eval first=strftime(first, "%%c")`
The last saved search (_ScheduledView__dashboard_%(shortname)s) is actually the one allowing the PDF scheduling. The $name$ parameter is a substitution parameter used by Splunk Mailing system.

**Note:**
I stumbled on another PDF scheduler bug: despite declaring in the scheduled view the format of the report (A3, Landscape), it is not used. It always fall back to the global splunk configuration found under System settings » Email settings 

### Dashboard template
The dashboard has been first manually created within the splunk GUI.
Once everything looks like you want, you can copy the generated xml, and replace the static parts with the parameter substitutions.
#### dashboard_template.xml 
```
<dashboard>
  <label>Dashboard %(shortname)s</label>
  <description />
  <row>
    <panel>
      <chart>
        <title>Dashboard trend</title>
        <searchName>dashboard_trend_%(shortname)s</searchName>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.axisY.minimumNumber">0</option>
        <option name="charting.axisY2.minimumNumber">0</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <title>Dashboard table</title>
        <searchName>dashboard_search1_%(shortname)s</searchName>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">heatmap</option>
        <option name="drilldown">none</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>
</dashboard>
```
Here we are using the "shortname" parameter to define the names of the saved searches.

## Dashboard generator script
Now the fun part: the dashboard generator script.

It is written in Python (internal language used by Splunk), and uses the Splunk Python instance (not the OS one). We are also using some modules from Splunk, as it allows to integrate the script into Splunk:

The script is started as a search from the app. It will log some info into /opt/splunk/var/log/splunk/dashboardGenerator.py.log (in turn added to the _internal index), as well as output events if everything worked fine.

As mentioned, there aren't many error checks, meaning in case of error you don't get much output and need to check the log.

The script takes one optional argument: the name of the config file (in the local/ directory). By default it is dashboard_generator.conf

In short it is doing the following:
-	getting all configuration parameters
-	loading the old savedsearches.conf file
-	delete any section which name contains "prefix" (dashboard_ in our case)
-	delete any dashboard file that match prefix_shortname-type.xml (this should take care the usecase when a report entry in the csv file has been deleted, i.e. we get rid of old stuff)
-	recreate new dashboard files
-	recreate all saved and scheduled searches needed for the dashboards
-	refresh view, saved searches, scheduled searches
-	reset the scheduled searches with the cron time, in order to force Splunk Scheduler to reevaluate the next time it must send the PDF (just refreshing the scheduled searches is not enough)
-	output as "events" some debugging info (only if nothing has gone wrong)

## Splunk integration as command
The script is integrated as a new command in the search language. It allows to be started from the Splunk GUI (not from the command line on the server), and with the credentials of the logged-in user.

Note:
I have only tried it with my credentials, which belongs to the admin group, so I actually don't know what really happens if you try with normal user credentials... maybe the files get generated, but the refresh will not work...? 

Anyway, two files are needed:

1) the commands.conf file defines the command and the script to call:
### commands.conf 
```
[dashboardgenerator]
filename = dashboardGenerator.py
passauth = true
```
2) the searchbnf.conf provides helps when typing the command in the search box in the Splunk UI:
### searchbnf.conf 
```
[dashboardgenerator-command]
syntax = | dashboardgenerator
shortdesc = Recreate dashboards based on template
description = This will recreate dashboards based on a template (both saved searches and view) and a lookup file (to know what dashboard to generate)
usage = public

[dashboardgenerator-options]
syntax = config_file
description = configuration file pointing to all other files (templates  and list). Default is dashboardgenerator.conf
```

Note:
I still have an issue with the searchbnf.conf file: the generic help works, but not the options part... need to debug that...

## Invocation
In order to regenerate all dashboards, you must type in the search box in the app where this setup is installed:

`| dashboardgenerator`

or with an argument pointing to another config file:

`| dashboardgenerator myconfig.conf`

You can look at the debug log file the log file (default debug setting to INFO, you can change it in the script itself to DEBUG):
`index=_internal source=*dashboardgenerator.py.log`

## UI cleanup
This script will generate a lot of saved seaches and dashboards. In order to keep the UI menu free from clutter, you can adapt your navigation menu to regroup the generated stuff together.

You need to go to the settings page, User interface » Navigation menus » default 
### default 
```
<nav>
    <view name="flashtimeline" default='true' />
    <collection label="Dashboards">
        <view source="unclassified" match="dashboard"/>
        <divider />
    </collection>
    <collection label="Views">
      <collection label="Generated dashboards">
            <view source="unclassified" match="dashboard_" />
        </collection>
      <divider />
        <view source="unclassified" />
        <divider />
    </collection>
    <collection label="Searches and Reports">
        <collection label="Reports">
            <saved source="unclassified" match="report" />
        </collection>
        <divider />
      <collection label="Mass reports">
            <saved source="unclassified" match="dashboard_" />
        </collection>
      <divider />
        <saved source="unclassified" />
    </collection>
</nav>
```
By adding two collections, looking for "saved" or "view" source matching your prefix ("dashboard_" in our case), we can regroup everything under submenus.


## PDF generating scripts hacks
Various hacks to the PDF generating scripts are needed to get a proper formating. These are overwritten by any Splunk upgrade. 

!! I had to set the default PDF report layout to A3 and Landscape. Individual settings in the scheduled view does not work (i.e. is not used). !!
 
### Larger charts
Charts have a hardcoded size, and are made for A4 or Letter (I think). For the A3 Layout we choosed, they are too small and truncates labels heavily.

The following changes hardcode a bigger value:
```
# [~/lib/python2.7/site-packages/splunk/pdf]> diff -u pdfgen_chart.py.old pdfgen_chart.py
--- pdfgen_chart.py.old 2015-01-21 15:20:03.161939270 +0100
+++ pdfgen_chart.py   2015-01-21 15:23:39.701480429 +0100
@@ -108,7 +108,7 @@
 class Chart(SvgBasedViz):
     def __init__(self, data, fields, props, runningAsScript=False):
-        SvgBasedViz.__init__(self, data, fields, props, width=600, height=350, genSvgScriptName="gensvg.js", runningAsScript=runningAsScript)
+        SvgBasedViz.__init__(self, data, fields, props, width=1200, height=350, genSvgScriptName="gensvg.js", runningAsScript=runningAsScript)
 class Map(SvgBasedViz):
     def __init__(self, data, fields, props, runningAsScript=False):
```

### Top alignment in table cells
Tables have a default bottom cell aligment. The following hack makes it top aligned, as on the web gui.
```
# [~/lib/python2.7/site-packages/reportlab/platypus]> diff -u tables.py.old tables.py
--- tables.py.old 2014-07-30 01:26:20.000000000 +0200
+++ tables.py  2014-11-14 11:23:12.000000000 +0100
@@ -42,7 +42,7 @@
     color = 'black'
     alignment = 'LEFT'
     background = 'white'
-    valign = "BOTTOM"
+    valign = "TOP"
     href = None
     destination = None
     def __init__(self, name, parent=None):
```

